<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../../../img/favicon.ico">
  <title>6 access control - Cely</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../../../css/theme.css" />
  <link rel="stylesheet" href="../../../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "6 access control";
    var mkdocs_page_input_path = "includes/understanding_keychain/6_access-control.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../../js/jquery-2.1.1.min.js"></script>
  <script src="../../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="../../..">
          <img src="/images/CelyLogo_beta.png" />
        </a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul >
                    <li class="toctree-l1"><a class="reference internal" href="../../installing-cely/">Installation</a>
    <ul >
    <li class="toctree-l2"><a class="reference internal" href="../../installing-cely/#carthage">Carthage</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="../../installing-cely/#cocoapods">CocoaPods</a>
    </li>
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Usage</span></p>
                <ul >
                    <li class="toctree-l1"><a class="reference internal" href="../../../usage/basic_usage/">Basic</a>
    <ul >
    <li class="toctree-l2"><a class="reference internal" href="../../../usage/basic_usage/#introduction">Introduction</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="../../../usage/basic_usage/#cely-setup">Cely Setup</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="../../../usage/basic_usage/#save-credentials">Save Credentials</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="../../../usage/basic_usage/#code">Code:</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="../../../usage/basic_usage/#whats-next">What's next?</a>
    </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../../usage/advance_usage/">Advance</a>
    <ul >
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Guides</span></p>
                <ul >
                    <li class="toctree-l1"><a class="reference internal" href="../../../guides/understanding_keychain/">Understanding Keychain</a>
    <ul >
    <li class="toctree-l2"><a class="reference internal" href="../../../guides/understanding_keychain/#introduction">Introduction</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="../../../guides/understanding_keychain/#keychain-anatomy">Keychain Anatomy</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="../../../guides/understanding_keychain/#keychain-operations">Keychain Operations</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="../../../guides/understanding_keychain/#accessibility">Accessibility</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="../../../guides/understanding_keychain/#add-faceidtouchid">Add FaceID/TouchID</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="../../../guides/understanding_keychain/#common-errors">Common Errors</a>
    </li>
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">API Reference</span></p>
                <ul >
                    <li class="toctree-l1"><a class="reference internal" href="../../../api/cely/">Cely</a>
    <ul >
    <li class="toctree-l2"><a class="reference internal" href="../../../api/cely/#setup_">setup(_:)</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="../../../api/cely/#changestatus_">changeStatus(_:)</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="../../../api/cely/#get_-gt-any">get(_:) -&gt; Any?</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="../../../api/cely/#save_-gt-result">save(_:) -&gt; Result</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="../../../api/cely/#currentloginstatus-gt-celystatus">currentLoginStatus() -&gt; CelyStatus</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="../../../api/cely/#logout_">logout(_:)</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="../../../api/cely/#isloggedin-gt-bool">isLoggedIn() -&gt; Bool</a>
    </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../../api/cely-credentials/">Cely Credentials</a>
    <ul >
    <li class="toctree-l2"><a class="reference internal" href="../../../api/cely-credentials/#set_-gt-result">set(_:) -&gt; Result</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="../../../api/cely-credentials/#get-gt-result">get() -&gt; Result</a>
    </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../../api/protocols/">Protocols</a>
    <ul >
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../../api/constants/">Constants</a>
    <ul >
    </ul>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../..">Cely</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../..">Docs</a> &raquo;</li>
    
      
    
    <li>6 access control</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <hr />
<h2 id="add-faceidtouchid">Add FaceID/TouchID<a class="headerlink" href="#add-faceidtouchid" title="Permanent link">#</a></h2>
<h3 id="access-control">Access Control<a class="headerlink" href="#access-control" title="Permanent link">#</a></h3>
<!--
In this section:
- NSFaceIDUsageDescription
- I want to explain what `kSecAttrAccessControl` is and why is it important.
- relationship between `kSecAttrAccessible` and `kSecAttrAccessControl`
  - what happens if you set conflicting accessible attributes (`kSecAttrAccessControl` & `kSecAttrAccessible`)?!
    - Result: you get a -50 error
-->

<p>In order to add biometrics such as FaceID or TouchID to a Keychain item, you must create a <a href="https://developer.apple.com/documentation/security/secaccesscontrol"><code>SecAccessControl</code></a> object using the <a href="https://developer.apple.com/documentation/security/1394452-secaccesscontrolcreatewithflags"><code>SecAccessControlCreateWithFlags(_:)</code></a> function and set it the <a href="https://developer.apple.com/documentation/security/ksecattraccesscontrol"><code>kSecAttrAccessControl</code></a> attribute.</p>
<p><em>example</em></p>
<pre><code class="swift">var error: Unmanaged&lt;CFError&gt;? = nil
let accessControlObject = SecAccessControlCreateWithFlags(nil,
                                            kSecAttrAccessibleWhenUnlocked,
                                            .userPresence,
                                            &amp;error)

let item: [CFString: Any] = [
    kSecClass: kSecClassInternetPassword,
    kSecAttrAccessControl: accessControlObject
    // ...
]

// ...
</code></pre>

<h3 id="flags">Flags<a class="headerlink" href="#flags" title="Permanent link">#</a></h3>
<!--
In this section:
I want to go over the different flags and what type of errors to expect in certain scenarios
-->

<p>In this section we will be going over some of the flags you can set and what errors you may encounter. In you want to see the entire list of flags, please checkout <a href="https://developer.apple.com/documentation/security/secaccesscontrolcreateflags"><code>SecAccessControlCreateFlag</code></a> for more information.</p>
<p>Flags we will go over:</p>
<ul>
<li><code>.userPresence</code> - FaceID/TouchID/Device Passcode.</li>
<li><code>.devicePasscode</code> - Device Passcode only.</li>
<li><code>.biometryAny</code> - FaceID/TouchID only (allows for biometrics changes).</li>
<li><code>.biometryCurrentSet</code> - FaceID/TouchID only (invalidates item when biometrics change).</li>
<li><code>.applicationPassword</code> - Application Specific password.</li>
</ul>
<h4 id="nsfaceidusagedescription">NSFaceIDUsageDescription<a class="headerlink" href="#nsfaceidusagedescription" title="Permanent link">#</a></h4>
<p>When using <code>.userPresence</code>, if <a href="https://developer.apple.com/documentation/bundleresources/information_property_list/nsfaceidusagedescription"><code>NSFaceIDUsageDescription</code></a> is not set in your plist, your application will revert to prompting the user for the Device Passcode. But when using <code>.biometryAny</code> or <code>.biometryCurrentSet</code>, failing to set <code>NSFaceIDUsageDescription</code> will result in your application crashing with the following error:</p>
<pre><code class="text">ERROR: This app has crashed because it attempted to access privacy-sensitive
data without a usage description. The app's Info.plist must contain
an NSFaceIDUsageDescription key with a string value explaining to
the user how the app uses this data.
</code></pre>

<h4 id="userpresence">.userPresence<a class="headerlink" href="#userpresence" title="Permanent link">#</a></h4>
<p><a href="https://developer.apple.com/documentation/security/secaccesscontrolcreateflags/1392879-userpresence"><code>.userPresence</code></a> is more than likely the flag you would be using in your application. Other flags such as <code>.devicePasscode</code> and <code>.biometryAny</code>, are simply slight derivatives of this flag.</p>
<p><img alt="" src="../../../images/understanding-keychain/userPresence-flow.jpg" /></p>
<p>Above is the flow you can expect for your application to take when saving/retrieving a Keychain Item with the <code>.userPresence</code> flag. <strong>It is very possible to encounter <a href="./#errsecauthfailed"><code>errSecAuthFailed: -25293</code></a> errors when working with <code>.userPresence</code> flagged items.</strong> Please review the above flows for a better understanding. In addition to the <em>Retrieving Flow</em>, If the user adds back a passcode to the device <em>(it doesn't have to be the same passcode)</em> the item can once again be retrieved.</p>
<h4 id="biometrycurrentset">.biometryCurrentSet<a class="headerlink" href="#biometrycurrentset" title="Permanent link">#</a></h4>
<p>The flag that differs from <code>.userPresence</code> the most would be <a href="https://developer.apple.com/documentation/security/secaccesscontrolcreateflags/2937192-biometrycurrentset">.biometryCurrentSet</a>, it invalidates any Keychain Items once a finger is added/removed on TouchID or if the user re-enrolls for FaceID.</p>
<p><img alt="" src="../../../images/understanding-keychain/biometryCurrentSet-flow.jpg" /></p>
<h4 id="applicationpassword">.applicationPassword<a class="headerlink" href="#applicationpassword" title="Permanent link">#</a></h4>
<p>The last flag we will go over is <a href="https://developer.apple.com/documentation/security/secaccesscontrolcreateflags/1617930-applicationpassword">.applicationPassword</a>, this allows for the user to set an application specific passcode in order to retrieve the item. When using this flag, iOS will prompt the user to insert a passcode. Meaning, you don't need to worry about providing a view to capture the application password. Unlike retrieving an item using device security such as <code>.devicePasscode</code>, after 5 failed attempts, Keychain returns the error <code>errSecAuthFailed: -25293</code> instead of disabling the item retrieval. Meaning, after 5 failed attempts the user can simply try again without being penalized.</p>
<h4 id="combining-flags">Combining Flags<a class="headerlink" href="#combining-flags" title="Permanent link">#</a></h4>
<p>In the case you want to authenticate the user with both <code>.userPresence</code> and <code>.applicationPassword</code>, you may combine them using an array.</p>
<pre><code class="swift">var error: Unmanaged&lt;CFError&gt;? = nil
let access = SecAccessControlCreateWithFlags(nil,
                                            kSecAttrAccessibleWhenUnlocked,
                                            [.userPresence, .applicationPassword],
                                            &amp;error)
</code></pre>

<p>Some combinations are not allowed such as <code>[.userPresence, .devicePasscode]</code>, so be sure to print out any errors for more information.</p>
<h3 id="faceidtouchid-example">FaceID/TouchID Example<a class="headerlink" href="#faceidtouchid-example" title="Permanent link">#</a></h3>
<p>In this example, we will create an item that will require FaceID, TouchID, or Passcode in order to be retrieved.</p>
<pre><code class="swift">@IBAction func saveWithAccessFlagClicked(_ sender: Any) {
    var error: Unmanaged&lt;CFError&gt;? = nil
    guard let access = SecAccessControlCreateWithFlags(nil,
                                                      kSecAttrAccessibleWhenUnlocked,
                                                      .userPresence,
                                                      &amp;error) else { return }

    let item: [CFString: Any] = [
        kSecClass: kSecClassInternetPassword,
        kSecAttrAccessControl: access,
        kSecAttrServer: &quot;example.com&quot;,
        kSecAttrAccount: &quot;username&quot;,
        kSecValueData: &quot;some-password&quot;.data(using: String.Encoding.utf8)!
    ]

    let status = SecItemAdd(item as CFDictionary, nil)
    guard status == errSecSuccess else {
        print(&quot;status:&quot;, status)
        return
    }

    print(&quot;successfully saved with access attribute&quot;)
}
</code></pre>

<p>Next, we will retrieve the <code>.userPresence</code> flagged item.</p>
<pre><code class="swift">@IBAction func QueryClicked(_ sender: Any) {

    let query: [CFString: Any] = [
        kSecClass: kSecClassInternetPassword,
        kSecAttrServer: &quot;example.com&quot;,
        kSecAttrAccount: &quot;username&quot;,
        kSecReturnAttributes: true,
        kSecReturnData: true
    ]

    var someItem: CFTypeRef?
    let status = SecItemCopyMatching(query as CFDictionary, &amp;someItem)
    guard status == errSecSuccess else {
        print(&quot;status:&quot;, status)
        return
    }

    guard let item = someItem,
        let username = item[kSecAttrAccount] as? String,
        let passwordData = item[kSecValueData] as? Data,
        let password = String(data: passwordData, encoding: .utf8) else {
        print(&quot;Item not found&quot;)
        return
    }

    print(&quot;username:&quot;, username)
    print(&quot;password:&quot;, password)
}
</code></pre>

<h3 id="ksecuseauthenticationuiskip">kSecUseAuthenticationUISkip<a class="headerlink" href="#ksecuseauthenticationuiskip" title="Permanent link">#</a></h3>
<!--
In this section:
- Querying Keychain and returns 2 items, one of which is protected by faceID. - What happens?
- go over:
  - [kSecUseAuthenticationUISkip](https://developer.apple.com/documentation/security/ksecuseauthenticationuiskip) - Silently skip any items that require user authentication.
-->

<p>When querying items from Keychain, you may be returned items that have the <code>kSecAttrAccessControl</code> attribute set, which will require the user to authenticate in order to retrieve the item. You can exclude these results by setting the <a href="https://developer.apple.com/documentation/security/ksecuseauthenticationui"><code>kSecUseAuthenticationUI</code></a> attribute in your query.</p>
<pre><code class="swift">
@IBAction func QueryAllClicked(_ sender: Any) {

    let query: [CFString: Any] = [
        kSecClass: kSecClassInternetPassword,
        kSecMatchLimit: kSecMatchLimitAll,
        kSecUseAuthenticationUI: kSecUseAuthenticationUISkip,
        ...
    ]

    var someItem: CFTypeRef?
    let status = SecItemCopyMatching(query as CFDictionary, &amp;someItem)
    ...
</code></pre>

<h4 id="notes">Notes<a class="headerlink" href="#notes" title="Permanent link">#</a></h4>
<p>When setting a <code>kSecAttrAccessControl</code> attribute on your Keychain Item, you cannot set the <code>kSecAttrAccessible</code> attribute on the Keychain Item itself. Doing so will result in a <code>errSecParam: -50</code> error, even if both are set to the same value. As an example, the following will return an error:</p>
<pre><code class="swift">var error: Unmanaged&lt;CFError&gt;? = nil
guard let access = SecAccessControlCreateWithFlags(nil,
                                                  kSecAttrAccessibleWhenUnlocked, // &lt;--
                                                  .userPresence,
                                                  &amp;error) else { return }

let query: [CFString: Any] = [
    kSecAttrAccessControl: access,
    kSecAttrAccessible:kSecAttrAccessibleWhenUnlocked, // &lt;--
    //...
]

let status = SecItemAdd(query as CFDictionary, nil) // equals -50 (errSecParam)
</code></pre>
              
            </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p>Copyright &copy; 2020 <a href="http://celylog.in">Cely</a></p>
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
      
    </span>
</div>
    <script>var base_url = '../../..';</script>
    <script src="../../../js/theme.js" defer></script>
      <script src="../../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(false);
        };
    </script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
  <!-- at the end of the BODY -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.js"></script>
  <script type="text/javascript">
    $(document).ready(() => $('table').addClass('docutils'));
    // PASTE doc search here
    /*
    docsearch({
      apiKey: '<KEY-GOES-HERE>',
      indexName: 'cely',
      inputSelector: '.wy-side-nav-search input[type="text"]',
      debug: false
    });
    */
  </script>

</body>
</html>
